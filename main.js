let cvReady=false,H=null,lastH=0,calibTimer=null,video,overlay,ctx,audioCtx;function onCvReady(){cv['onRuntimeInitialized']=()=>{cvReady=true;document.getElementById('splash').remove();}}
async function startCam(w=640,h=480){let s=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:w},height:{ideal:h},frameRate:{ideal:60,max:60}}});video.srcObject=s;await video.play();overlay.width=video.videoWidth;overlay.height=video.videoHeight;}
async function start(){if(!cvReady)return alert('CV not ready');audioCtx=new (AudioContext||webkitAudioContext)();await audioCtx.resume();await startCam();startCalib();}
function startCalib(){if(calibTimer)clearInterval(calibTimer);calibTimer=setInterval(()=>{let c=cv.imread(video);let g=new cv.Mat();cv.cvtColor(c,g,cv.COLOR_RGBA2GRAY);let d=cv.aruco.Dictionary_get(cv.aruco.DICT_4X4_50);let p=new cv.aruco.DetectorParameters();let ids=new cv.Mat();let corners=new cv.MatVector();try{cv.aruco.detectMarkers(g,d,corners,ids,p);document.getElementById('status').textContent='markers:'+corners.size();}catch(e){}c.delete();g.delete();corners.delete();ids.delete();},150);}
document.addEventListener('DOMContentLoaded',()=>{video=document.getElementById('video');overlay=document.getElementById('overlay');ctx=overlay.getContext('2d');document.getElementById('startBtn').onclick=start;document.getElementById('calibBtn').onclick=startCalib;});
